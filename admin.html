<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin - Arsip Pemersatu Bangsa</title>
  <style>
    body {
      margin: 0;
      background: #0b0b0b;
      color: #f0f0f0;
      font-family: Inter, system-ui, sans-serif;
    }
    .container {
      max-width: 1100px;
      margin: 24px auto;
      padding: 0 16px;
    }
    input, textarea {
      width: 100%;
      padding: 10px;
      margin: 6px 0;
      border-radius: 8px;
      border: 1px solid #222;
      background: #111;
      color: #f0f0f0;
    }
    button {
      padding: 10px 14px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      background: #2563eb;
      color: white;
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 16px;
      margin-top: 20px;
    }
    .card {
      background: #111;
      padding: 10px;
      border-radius: 8px;
    }
    .thumb {
      width: 100%;
      height: 140px;
      background-size: cover;
      background-position: center;
      border-radius: 6px;
      margin-bottom: 8px;
    }
    .flex {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    .title {
      color: #38bdf8;
      margin-bottom: 5px;
    }
    .logout {
      background: #ef4444;
    }
  </style>
</head>
<body>
  <div class="container">

    <!-- === LOGIN ADMIN === -->
    <div id="loginSection">
      <h2>Login Admin</h2>
      <input type="password" id="passwordInput" placeholder="Masukkan password admin..." />
      <button id="loginBtn">Login</button>
    </div>

    <!-- === DASHBOARD ADMIN === -->
    <div id="adminPanel" style="display:none">
      <div class="flex" style="justify-content:space-between;align-items:center;">
        <h1>Panel Admin - Arsip Pemersatu Bangsa</h1>
        <div class="flex">
          <button id="toIndex">Lihat Website</button>
          <button id="changeToken">Ganti Token</button>
          <button id="logout" class="logout">Logout</button>
        </div>
      </div>

      <hr style="margin:20px 0;border:0;border-top:1px solid #333">

      <!-- === FORM TAMBAH / EDIT VIDEO === -->
      <h3>Tambah / Edit Video</h3>
      <input type="text" id="title" placeholder="Judul video">
      <input type="text" id="url" placeholder="Link video (mp4 / embed)">
      <input type="text" id="thumbnail" placeholder="Link thumbnail">
      <input type="number" id="views" placeholder="Jumlah views (opsional)">
      <button id="saveVideo">Simpan Video</button>

      <hr style="margin:20px 0;border:0;border-top:1px solid #333">

      <!-- === DAFTAR VIDEO === -->
      <h3>Daftar Video</h3>
      <input type="search" id="searchVideo" placeholder="Cari berdasarkan judul...">
      <div id="videoList" class="grid"></div>

      <hr style="margin:20px 0;border:0;border-top:1px solid #333">

      <!-- === STATISTIK === -->
      <h3>Statistik Situs</h3>
      <div id="stats"></div>
      <button id="editStats">Edit Statistik</button>

      <hr style="margin:20px 0;border:0;border-top:1px solid #333">

      <!-- === GANTI PASSWORD === -->
      <h3>Ganti Password Admin</h3>
      <input type="password" id="newPassword" placeholder="Password baru">
      <button id="savePassword">Ubah Password</button>
    </div>

  </div>

  <script>
    /* === KONFIGURASI === */
    const GITHUB_USER = "Fionks";
    const REPO = "Website-xxx";
    const BRANCH = "main";
    const SITE_URL = "https://arsippemersatubangsa.netlify.app/";

    const RAW = `https://raw.githubusercontent.com/${GITHUB_USER}/${REPO}/${BRANCH}`;
    const API = `https://api.github.com/repos/${GITHUB_USER}/${REPO}/contents`;

    /* === VARIABEL GLOBAL === */
    let videos = [];
    let stats = {};
    let adminPass = "";
    let githubToken = sessionStorage.getItem("githubToken") || null;

    /* === DOM ELEMENTS === */
    const loginSection = document.getElementById("loginSection");
    const adminPanel = document.getElementById("adminPanel");
    const passwordInput = document.getElementById("passwordInput");
    const loginBtn = document.getElementById("loginBtn");
    const logoutBtn = document.getElementById("logout");
    const toIndexBtn = document.getElementById("toIndex");
    const changeTokenBtn = document.getElementById("changeToken");
    const videoList = document.getElementById("videoList");
    const searchVideo = document.getElementById("searchVideo");
    const saveVideoBtn = document.getElementById("saveVideo");

    /* === FUNGSI UMUM === */
    async function loadJSON(path) {
      const res = await fetch(`${RAW}/${path}?_=${Date.now()}`);
      if (!res.ok) throw new Error(res.status);
      return res.json();
    }

    function decodeBase64(str) {
      try {
        return decodeURIComponent(escape(atob(str)));
      } catch {
        return atob(str);
      }
    }

    async function getGitHubFile(file) {
      const res = await fetch(`${API}/${file}?ref=${BRANCH}`);
      const data = await res.json();
      const content = decodeBase64(data.content);
      return { json: JSON.parse(content), sha: data.sha };
    }

    async function saveToGitHub(file, json, sha, msg) {
      if (!githubToken) {
        githubToken = prompt("Masukkan GitHub Token kamu:");
        sessionStorage.setItem("githubToken", githubToken);
      }
      const content = btoa(unescape(encodeURIComponent(JSON.stringify(json, null, 2))));
      const res = await fetch(`${API}/${file}`, {
        method: "PUT",
        headers: {
          "Authorization": `token ${githubToken}`,
          "Content-Type": "application/json"
        },
        body: JSON.stringify({ message: msg, content, sha, branch: BRANCH })
      });
      if (!res.ok) throw new Error("Gagal menyimpan ke GitHub");
      return res.json();
    }

    /* === LOGIN === */
    async function checkLogin() {
      const data = await loadJSON("admin.json");
      adminPass = data.password;
      if (passwordInput.value.trim() === adminPass) {
        loginSection.style.display = "none";
        adminPanel.style.display = "block";
        loadAllData();
      } else {
        alert("Password salah!");
      }
    }
    loginBtn.onclick = checkLogin;
    logoutBtn.onclick = () => location.reload();

    /* === NAVIGASI WEBSITE === */
    toIndexBtn.onclick = () => window.open(SITE_URL, "_blank");

    /* === GANTI TOKEN === */
    changeTokenBtn.onclick = () => {
      const t = prompt("Masukkan GitHub Token baru:");
      if (t) {
        sessionStorage.setItem("githubToken", t);
        githubToken = t;
        alert("Token berhasil diperbarui!");
      }
    };

    /* === MUAT SEMUA DATA === */
    async function loadAllData() {
      const [vid, stat] = await Promise.all([
        loadJSON("videos.json"),
        loadJSON("stats.json")
      ]);
      videos = vid;
      stats = stat;
      renderVideoList();
      renderStats();
    }

    /* === DAFTAR VIDEO === */
    function renderVideoList(list = videos) {
      videoList.innerHTML = "";
      list.forEach((v, i) => {
        const div = document.createElement("div");
        div.className = "card";
        div.innerHTML = `
          <div class="thumb" style="background-image:url('${v.thumbnail}')"></div>
          <div class="title">${v.title}</div>
          <div>Views: ${v.views}</div>
          <button onclick="editVideo(${i})">Edit</button>
          <button onclick="deleteVideo(${i})" class="logout">Hapus</button>
        `;
        videoList.appendChild(div);
      });
    }

    /* === EDIT / HAPUS VIDEO === */
    let editIndex = null;
    function editVideo(i) {
      const v = videos[i];
      document.getElementById("title").value = v.title;
      document.getElementById("url").value = v.url;
      document.getElementById("thumbnail").value = v.thumbnail;
      document.getElementById("views").value = v.views;
      editIndex = i;
    }

    async function deleteVideo(i) {
      if (!confirm("Yakin ingin hapus video ini?")) return;
      videos.splice(i, 1);
      await saveData("videos.json", videos, "Hapus video");
      renderVideoList();
    }

    /* === TAMBAH / SIMPAN VIDEO === */
    saveVideoBtn.onclick = async () => {
      const t = document.getElementById("title").value.trim();
      const u = document.getElementById("url").value.trim();
      const th = document.getElementById("thumbnail").value.trim();
      const v = parseInt(document.getElementById("views").value) || 0;
      if (!t || !u || !th) return alert("Lengkapi semua kolom!");

      const obj = { title: t, url: u, thumbnail: th, views: v };
      if (editIndex !== null) {
        videos[editIndex] = obj;
        editIndex = null;
      } else {
        videos.unshift(obj);
      }
      await saveData("videos.json", videos, "Update daftar video");
      renderVideoList();
      alert("Video berhasil disimpan!");
    };

    /* === SIMPAN DATA === */
    async function saveData(file, data, message) {
      const { sha } = await getGitHubFile(file);
      await saveToGitHub(file, data, sha, message);
    }

    /* === PENCARIAN VIDEO === */
    searchVideo.oninput = e => {
      const q = e.target.value.toLowerCase();
      renderVideoList(videos.filter(v => v.title.toLowerCase().includes(q)));
    };

    /* === STATISTIK === */
    function renderStats() {
      document.getElementById("stats").innerHTML = `
        Total Pengunjung: ${stats.totalVisitors}<br>
        Pengunjung Hari Ini: ${stats.todayVisitors}<br>
        Total Views: ${stats.totalViews}
      `;
    }

    document.getElementById("editStats").onclick = async () => {
      stats.totalVisitors = parseInt(prompt("Total pengunjung:", stats.totalVisitors)) || stats.totalVisitors;
      stats.todayVisitors = parseInt(prompt("Pengunjung hari ini:", stats.todayVisitors)) || stats.todayVisitors;
      stats.totalViews = parseInt(prompt("Total views:", stats.totalViews)) || stats.totalViews;
      await saveData("stats.json", stats, "Edit statistik");
      renderStats();
    };

    /* === GANTI PASSWORD === */
    document.getElementById("savePassword").onclick = async () => {
      const newPass = document.getElementById("newPassword").value.trim();
      if (!newPass) return alert("Masukkan password baru!");
      const { sha } = await getGitHubFile("admin.json");
      await saveToGitHub("admin.json", { password: newPass }, sha, "Ganti password admin");
      alert("Password berhasil diubah!");
    };
  </script>
</body>
</html>
